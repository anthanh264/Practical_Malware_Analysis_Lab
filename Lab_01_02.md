# Phân Tích Mã Độc Practical Malware Analysis Lab01-02
# Table of contents

- [Phân Tích Mã Độc Practical Malware Analysis Lab01-02](#phân-tích-mã-độc-practical-malware-analysis-lab01-02)
  - [Phân tích](#phân-tích)
  - [Phát hiện](#phát-hiện)
  - [Gỡ bỏ](#gỡ-bỏ)
## Phân tích
- Lab01-02 gồm 1 file .EXE, được pack bằng UPX 3.04. Có thể unpack file Lab01-02.exe bằng upx, sử dụng lệnh upx -d.
![](https://i.imgur.com/p7dqiPo.png)
- Mã độc chỉ có hai hàm chức năng đáng chú ý
    + Hàm sub_401040 tạo một mutex với tên “HGL345” để đảm bảo tại một thời điểm chí có một instance duy nhất của mã độc được thực thi trong hệ thống. Sau đó mã độc tạo auto start service gọi đến chính file thực thi mã độc
    ![](https://i.imgur.com/am238Q9.png)
    + Sau khi tạo auto start service, mã độc tạo một bộ hẹn giờ tới thời điểm 0h00 ngày 1/1/2100 sẽ tạo một thread mới gọi hàm StartAddress.
    ![](https://i.imgur.com/BHwaUvO.png)
     + Hàm StartAddress thực hiện lặp vô tận thao tác kết nối tới địa chỉ “http://www.malwareanalysisbook.com” với UA là “Internet Explorer 8.0”.
    ![](https://i.imgur.com/lUh51xh.png)
- Mã độc tạo các registry key:
```
HKLM\SYSTEM\ControlSet001\Services\Malservice
HKLM\SYSTEM\ControlSet001\Services\Malservice\Security
HKLM\SYSTEM\CurrentControlSet\Services\Malservice
HKLM\SYSTEM\CurrentControlSet\Services\Malservice\Security
```
- Như vậy, Lab01-02.exe được cài đặt như một bot, sử dụng bộ đếm giờ tới 0h00 ngày 1/1/2100 thực hiện một cuộc tấn công DoS/DDoS vào máy chủ web của website http://malwareanalysis.com
## Phát hiện
- Lab01-02.exe có thể được phát hiện bằng signature, lấy 20 byte từ file offset 2080 và 2436 để làm signature.
![](https://i.imgur.com/yfYwQjl.png)
![](https://i.imgur.com/UTe1vVH.png)

## Gỡ bỏ
- Kill handle và xóa file thực thi mã độc
- Xóa key `HKLM\SYSTEM\CurrentControlSet\Services\Malservice`, key `HKLM\SYSTEM\ControlSet001\Services\Malservice` và service object trong Service Control Manager tự động được xóa.
![](https://i.imgur.com/PfeEIJe.png)
